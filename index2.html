<!DOCTYPE html>
<html>

<head>
    <title>673 Module 07 N Williamson</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />

    <style>
        html,
        body,
        #map {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        h1 {
            position: absolute;
            z-index: 650;
            top: 10px;
            left: 50px;
            padding: 8px 15px;
            margin: 0;
            color: whitesmoke;
            font-size: 2em;
            background: rgba(192, 192, 192, 0.2);
            border-radius: 5px;
        }
        /* Try Ramiro's code begin */

        .species-selector {
            width: 175px;
            bottom: 25px;
        }
        /* Try Ramiro's code end */
    </style>
</head>

<!-- <div class="ui-widget">
  <label for="common">Common name: </label>
  <input id="common">
</div>

<div class="ui-widget" style="margin-top: 2em; font-family:Arial">
  <div id="log" style="height: 15px; width: 200px; overflow: hidden;" class="ui-widget-content"></div>
</div> -->

<body>

  <!-- Here are the two sources I used in trying to incorporate an autofill box
  connected to my data, which would allow users to search for a tree species -->

  <!-- Javi's code link:

    http://bl.ocks.org/javisantana/7932459

  -->

  <!-- Ramiro's code link:

    http://bl.ocks.org/ramiroaznar/892e5ab475877adb564b3b0eb3383dd5

  -->


  <!--Rich solution for tooltip begin -->

  <!-- <script type="infowindow/html" id="infowindow_template">
        <div class="CDB-Tooltip CDB-Tooltip--isLight">
             <ul class="CDB-Tooltip-list">
                 <li class="CDB-Tooltip-listItem">
                     <h3 class="CDB-Tooltip-listTitle">dbh_bin</h3>
                   <h4 class="CDB-Tooltip-listText">{{dbh_bin}}</h4>
                 </li>
                 <li class="CDB-Tooltip-listItem">
                     <h3 class="CDB-Tooltip-listTitle">exact_dbh</h3>
                   <h4 class="CDB-Tooltip-listText">{{exact_dbh}}</h4>
                 </li>
                 <li class="CDB-Tooltip-listItem">
                     <h3 class="CDB-Tooltip-listTitle">botanical</h3>
                   <h4 class="CDB-Tooltip-listText">{{botanical}}</h4>
                 </li>
                 <li class="CDB-Tooltip-listItem">
                     <h3 class="CDB-Tooltip-listTitle">common</h3>
                   <h4 class="CDB-Tooltip-listText">{{common}}</h4>
                 </li>
             </ul>
           </div>
    </script> -->

    <!--Rich solution for tooltip end -->

    <!-- Try Ramiro's code for drop-down autofill begin -->

    <!-- selector div -->
    <!-- <div id="wraper-city-selector">
        <select class="species-selector">
      <option value="#" selected disabled>Select a tree species</option>
    </select>
    </div> -->

    <!-- Try Ramiro's code end -->

    <h1>University of Kentucky Tree Map</h1>
    <div id="map"></div>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script> -->

    <!-- Try Javi's code begin -->

    <!-- <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"> -->

    <!-- Try Javi's code end -->

    <!--try Ramiro's <code> begin -->

    <!-- except this! -->
    <!-- <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
        <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script> -->

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>

    <!--try Ramiro's <code> end -->

    <script type="cartocss/html" id="tree-styles">

        #layer { marker-fill: #00FF7F; marker-allow-overlap: true; [distinc=1] { marker-fill: #52d017; } [distinc=2] { marker-fill: #136400; } [distinc=3] { marker-fill: #0000FF; } } //

    </script>

      <script type="text/sql" id="query">
        SELECT * FROM ukntrees_adopt_oct62016b_1
      </script>

    <!-- Try Javi's code begin -->

    <!-- /*<style>
           .ui-autocomplete-loading {
             background: white right center no-repeat;
           }
           </style>*/ -->

    <!-- <script>
      $(function() {

        function log( message ) {
          $( "<div>" ).text( message ).prependTo( "#log" );
          $( "#log" ).scrollTop( 0 );
        }

        var sql = cartodb.SQL({ user: 'npwi222' });
        $( "#common" ).autocomplete({
          source: function( request, response ) {
            var s
            sql.execute("select common from ukntrees_adopt_oct62016b_1 where common ilike '"  request.term  "%'").done(function(data) {
               response(data.rows.map(function(r) {
                  return {
                    label: r.common,
                    value: r.common
                  }
                })
              )
            })
          },
          minLength: 2,
          select: function( event, ui ) {
            log( ui.item ?
              "Selected: "  ui.item.value :
              "Nothing selected, input was "  this.value );
          }
        });
      });
      </script> -->

    <!-- Try Javi's code end -->

    <script>
        var map = L.map('map', {
            center: [38.035, -84.505],
            zoom: 15,
        });

        //Try Ramiro's code begin //

        // get selector
        var selector = $(".species-selector-selector");

        // get styles & query
        //  style = $("#tree-styles").text(),
        query = $("#query").text(),

            //Try Ramiro's code end //

            sourceObject = {
                user_name: 'npwi222',
                type: 'cartodb',
                sublayers: [{
                        type: "http",
                        urlTemplate: "http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
                        subdomains: ["a", "b", "c"]
                    },

                    // Try Ramiro's code begin

                    // {
                    //   sql: query,
                    //   cartocss: $("#tree-styles").text()
                    // },

                    // Try Ramiro's code end
                    {
                        sql: "SELECT * FROM ukntrees_adopt_oct62016b_1",
                        cartocss: $("#tree-styles").text()
                    }
                ]
            } //end sourceObject variable



        cartodb.createLayer(map, sourceObject)

        //   {
        //   infowindows: true,
        // })

        .addTo(map)

            //Try Ramiro's code begin //

            .done(function(layer) {

              // Rich suggestion for infowindow begin

              // var sublayer = layer.getSubLayer(1);
              //
              //        cartodb.vis.Vis.addInfowindow(map, sublayer, ['common', 'botanical', 'exact_dbh', 'treeid'], {
              //            infowindowTemplate: $('#infowindow_template').text(),
              //            templateType: 'mustache'
              //        });
              //
              //          layer.leafletMap.viz.addOverlay({
              //          type: 'tooltip',
              //          layer: sublayer,
              //          template: $('#infowindow_template').text(),
              //          position: 'bottom|right',
              //          fields: [{ common:'common', botanical:'botanical', exact_dbh:'exact_dbh', treeid: 'treeid'}]
              //          });

                      // Rich suggestion for infowindow end

                // Try Ramiro's code (continue)

                // declare sublayer variable
                var cityLayer = layer.getSubLayer(0);

                // populate selector with city names from sublayer data
                var sql = new cartodb.SQL({
                    user: 'npwi222'
                });

                sql.execute(query)
                    .done(function(data) {
                        for (var i = 0; i < data.total_rows; i) {

                            var name = data.rows[i].common;

                            selector.append("<option value="  common  ">"  common  "</option>");
                        }
                    });

                selector.select2();

                // filter cities when selecting an option from selector
                selector.change(function() {

                    var input = $(".species-selector option:selected").val();

                    console.log("You have selected "  input  ".");

                    cityLayer.setSQL(query  " AND name ilike '"  input  "'");

                });
            });

        //Try Ramiro code end //

    </script>
</body>

</html>
